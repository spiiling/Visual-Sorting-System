# ESP32-S3 智能视觉分拣系统 (FreeRTOS + PaddleOCR)

![Python](https://img.shields.io/badge/Python-3.9%2B-blue?logo=python) ![ESP32-S3](https://img.shields.io/badge/ESP32--S3-IDF%20%26%20Arduino-orange?logo=espressif) ![FreeRTOS](https://img.shields.io/badge/FreeRTOS-Real--Time-green) ![PaddleOCR](https://img.shields.io/badge/PaddleOCR-OCR-red) ![License](https://img.shields.io/badge/License-MIT-brightgreen)

这是一个基于 ESP32-S3 的小型自动化物流分拣系统。项目核心是利用运行在 PC 上的 PaddleOCR 模型进行高速视觉识别，并将识别到的包裹关键字通过局域网发送给作为主控的 ESP32-S3。ESP32-S3 采用 FreeRTOS 实时操作系统，高效、稳定地管理多个硬件外设（传送带、分拣舵机、卸货舵机、传感器等），并根据指令完成包裹的分拣、暂存，最终调度 ESP8266 小车进行取货。

同时，系统支持通过“巴法云”物联网平台，让用户能使用微信小程序动态修改和配置需要识别的关键字，实现了云、管、边、端一体化的设计思想。

---

## 目录

*   [系统架构](#系统架构)
*   [核心功能与亮点](#核心功能与亮点)
*   [硬件清单](#硬件清单)
*   [部署与使用](#部署与使用)
    *   [第一步：硬件连接](#第一步硬件连接)
    *   [第二步：PC 端上位机环境配置](#第二步pc-端上位机环境配置)
    *   [第三步：ESP32-S3 主控固件烧录](#第三步esp32-s3-主控固件烧录)
    *   [第四步：巴法云与小程序配置](#第四步巴法云与小程序配置)
    *   [第五步：ESP8266 小车固件（待更新）](#第五步esp8266-小车固件待更新)
*   [运行流程](#运行流程)
*   [未来计划 (To-Do)](#未来计划-to-do)
*   [开源许可](#开源许可)
*   [作者](#作者)

---

## 系统架构

本系统由四个主要部分组成，通过局域网和公网进行通信，协同工作：

1.  **PC 端上位机 (Python GUI)**：
    *   **角色**：视觉处理中心和总指挥。
    *   **技术**：使用 `PySide6` 构建图形界面，通过 `OpenCV` 调用摄像头获取传送带上的实时视频流。
    *   **核心**：集成 `PaddleOCR` 深度学习模型，对视频帧中的图像进行文字识别。
    *   **通信**：当识别到预设关键字时，通过 **HTTP GET** 请求将关键字发送给 ESP32-S3 主控。

2.  **ESP32-S3 主控**：
    *   **角色**：系统的核心控制器，负责实时任务处理和硬件驱动。
    *   **技术**：基于 `Arduino` 框架和 `ESP-IDF` 底层 API，充分利用 `FreeRTOS`。
    *   **核心**：内置一个轻量级 HTTP 服务器接收来自 PC 的指令；通过多任务、队列、事件组和互斥锁管理分拣流程的状态机；精确驱动多个舵机和传送带电机。
    *   **通信**：
        *   接收 PC 的 **HTTP** 指令。
        *   通过 **TCP** 连接到“巴法云”，接收小程序下发的关键字更新指令。
        *   通过 **TCP** 连接到 ESP8266 小车，发送取货指令。

3.  **ESP8266 搬运小车**：
    *   **角色**：最终执行取货和搬运任务的执行器。
    *   **技术**：（待完善）
    *   **通信**：作为一个 **TCP 服务器**，等待 ESP32-S3 的连接和指令。

4.  **云端与微信小程序**：
    *   **角色**：远程配置中心。
    *   **技术**：使用“巴法云”物联网平台。
    *   **核心**：用户可在微信小程序中修改三个分拣口对应的目标关键字（如“桥头镇”），巴法云平台会将更新通过 TCP 推送给在线的 ESP32-S3。

**数据流示意图：**
```
+----------------+      HTTP (关键字)     +--------------+      TCP (取货指令)      +--------------+
| PC (PaddleOCR) | ---------------------> | ESP32-S3 主控 | ---------------------> | ESP8266 小车 |
+----------------+                        +--------------+                        +--------------+
      ^                                          ^
      | 视频流 (USB)                                | TCP (更新关键字)
      |                                          |
+-----------+                               +-------------------------+
|  摄像头   |                               | 巴法云 / 微信小程序     |
+-----------+                               +-------------------------+
```

---

## 核心功能与亮点

*   **真正的多任务系统**：基于 FreeRTOS，将UI交互、网络通信、电机控制、状态管理分解到不同任务中，互不阻塞，响应迅速。
*   **健壮的状态机设计**：每个分拣口都有独立的状态机（`IDLE`, `PACKAGE_EXPECTED`, `PACKAGE_ARRIVED`...），确保了复杂逻辑的稳定运行。
*   **任务间的高效通信**：综合运用了 FreeRTOS 的三大法宝：
    *   **队列 (Queue)**: 用于 PC 任务向小车调度任务安全地“派单”。
    *   **事件组 (Event Group)**: 用于 ISR (红外传感器中断) 快速、无锁地通知等待任务。
    *   **互斥锁 (Mutex)**: 用于保护 `sortingPorts` 等全局共享资源，防止多任务并发访问导致数据错乱。
*   **混合网络编程**：项目同时使用了 HTTP Server (接收PC指令)、TCP Client (连接巴法云和小车)，是物联网通信的典型应用场景。
*   **PC端先进的GUI与OCR**：使用 PySide6 (Qt for Python) 构建了功能完善的图形界面，并通过多线程将耗时的 OCR 任务与 UI 刷新分离，避免界面卡顿。
*   **云端动态配置**：无需重新烧录固件，即可通过小程序远程更改分拣逻辑，极大提高了系统的灵活性。

---

## 硬件清单

| 类别 | 器件名称 | 数量 | 备注 |
| :--- | :--- | :--- | :--- |
| **核心控制器** | ESP32-S3 开发板 | 1 | 建议使用带有 PSRAM 的版本 |
| **执行器** | ESP8266 开发板 (如 NodeMCU) | 1 | 用于搬运小车 |
| **电机与驱动** | 传送带直流电机 | 1 | |
| | TB6612FNG 电机驱动模块 | 1 | 用于驱动传送带电机 |
| **舵机** | MG90S 或 SG90 舵机 | 6 | 3个用于分拣，3个用于卸货 |
| **传感器** | 红外对射/反射传感器 | 3 | 用于检测包裹是否到达分拣口 |
| **PC 与外设** | 电脑 | 1 | 运行 Python 上位机程序，建议带NVIDIA显卡以使用GPU加速 |
| | USB 摄像头 | 1 | |
| **其他** | 杜邦线、面包板、电源模块等 |若干| 建议为舵机和电机独立供电 |

---

## 部署与使用

### 第一步：硬件连接

请根据以下表格将传感器和驱动器连接到 ESP32-S3 的 GPIO 引脚。

| 组件 | ESP32-S3 引脚 |
| :--- | :--- |
| **传送带电机 (TB6612FNG)** | |
| `STBY` | GPIO 4 |
| `PWMA` | GPIO 18 |
| `AIN1` | GPIO 5 |
| `AIN2` | GPIO 6 |
| **分拣口 0** | |
| 分拣舵机 | GPIO 2 |
| 红外传感器 | GPIO 1 |
| **分拣口 1** | |
| 分拣舵机 | GPIO 21 |
| 红外传感器 | GPIO 47 |
| **分拣口 2** | |
| 分拣舵机 | GPIO 20 |
| 红外传感器 | GPIO 19 |
| **卸货站 0 (关联分拣口2)** | |
| 卸货舵机 | GPIO 10 |
| **卸货站 1 (关联分拣口1)** | |
| 卸货舵机 | GPIO 9 |
| **卸货站 2 (关联分拣口0)** | |
| 卸货舵机 | GPIO 8 |

### 第二步：PC 端上位机环境配置

1.  安装 Python (推荐 3.9 或更高版本)。
2.  安装所需的库。打开命令行或终端，运行：
    ```bash
    pip install -r requirements.txt
    ```
    或者手动安装：
    ```bash
    pip install paddlepaddle-gpu # 或者 paddlepaddle，如果使用CPU
    pip install paddleocr requests PySide6 opencv-python numpy
    ```
    **注意：** 要使用 GPU 加速，请确保您的电脑有 NVIDIA 显卡，并已正确安装 CUDA 和 cuDNN。

### 第三步：ESP32-S3 主控固件烧录

1.  推荐使用 **Visual Studio Code** + **PlatformIO** 插件作为开发环境。
2.  在 `main.ino` (或等效的主文件) 中，修改以下信息：
    ```cpp
    const char* ssid = "YOUR_WIFI_SSID";       // 替换为你的WiFi账号
    const char* password = "YOUR_WIFI_PASSWORD"; // 替换为你的WiFi密码
    ```
3.  在 `state_manager.cpp` 中，修改您的巴法云私钥：
    ```cpp
    const char* BAFACLOUD_UID = "YOUR_BAFAYUN_PRIVATE_KEY"; // 替换为你的巴法云私钥
    ```
4.  连接 ESP32-S3 开发板，点击 PlatformIO 的 "Upload" 按钮进行编译和烧录。

### 第四步：巴法云与小程序配置

1.  登录巴法云官网，获取您的私钥。
2.  创建三个主题，名称必须与 `state_manager.cpp` 中的 `TOPIC_SG1`, `TOPIC_SG2`, `TOPIC_SG3` 完全一致（`SG1date006`, `SG2date006`, `SG3date006`）。
3.  使用巴法云提供的小程序模板，或自行开发，实现向这三个主题发送消息的功能。

### 第五步：ESP8266 小车固件（待更新）

此部分代码正在完善中，将会在后续更新中提供。

---

## 运行流程

1.  **启动硬件**：为 ESP32-S3、传送带、舵机等所有硬件上电。ESP32-S3 会自动连接 WiFi 并启动所有任务和 HTTP 服务器。
2.  **启动上位机**：运行 `ocr_gui_pyside6.py` 文件，打开PC端控制程序。
3.  **配置 IP**：在 GUI 界面中，确保 "ESP32 摄像头 IP" 和 "ESP32 关键字接收 IP" 都填写了您 ESP32-S3 启动后在串口监视器中打印出的 IP 地址。
4.  **开始识别**：点击 "开始识别" 按钮。程序会开始从摄像头获取视频流，并进行实时 OCR。
5.  **放置包裹**：将带有文字的包裹放到传送带上。
6.  **自动分拣**：
    *   PC 端识别到与巴法云设置的关键字匹配的文字后，会立刻向 ESP32-S3 发送 HTTP 请求。
    *   ESP32-S3 收到请求，对应分拣口进入 `PACKAGE_EXPECTED` 状态。
    *   当包裹经过红外传感器时，触发中断，ESP32-S3 控制相应舵机将包裹推下传送带。
    *   包裹进入卸货站，ESP32-S3 将取货任务放入队列。
7.  **小车调度**：
    *   ESP32-S3 的小车通信任务从队列中取出任务，通过 TCP 连接到 ESP8266，发送取货指令。
    *   （后续流程待小车代码完善后补充）

---

## 未来计划 (To-Do)

- [ ] 完成并上传 ESP8266 小车的完整固件和说明。
- [ ] 绘制详细的系统电路连接图 (Fritzing 或其他工具)。
- [ ] 增加上位机对多个摄像头的支持。
- [ ] 优化 OCR 识别区域 (ROI)，提高识别效率。

---

## 开源许可

本项目采用 [MIT License](./LICENSE) 开源许可证。

---

## 作者

（这里写你的 GitHub 用户名或昵称）