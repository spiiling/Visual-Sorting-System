# 搬运小车固件 (STM32U5 + ESP8266)

本项目是“ESP32-S3 智能视觉分拣系统”的物理执行单元——自动循迹搬运小车。它由两块核心芯片协同工作，负责接收主控指令，并精确地执行取货和送货任务。

---

## 硬件架构

小车采用了“主控+通信”分离的设计，以确保实时任务的稳定性和网络连接的便利性。

*   **主控核心: STM32U5**
    *   **角色**: 小车的“大脑”，负责所有实时控制任务。
    *   **主要职责**:
        *   **电机控制**: 通过 `TIM1` 和 `TIM8` 产生多路 PWM，精确控制四个轮子的速度和方向。
        *   **循迹算法**: 读取三个红外传感器 (`ADC1`) 的值，实现经典的黑线循迹逻辑。
        *   **状态机管理**: 内置一个完整的任务状态机，管理“待命->取货->送货->返航”的完整流程。
        *   **串口通信**: 通过 `USART3` 与 ESP8266 模块进行指令和状态的交互。

*   **通信模块: ESP8266**
    *   **角色**: 小车的“通信官”，负责网络连接。
    *   **工作模式**: 作为一个“TCP转串口”的透明传输模块。它连接到指定的 WiFi，并作为一个 TCP 服务器运行在 `8888` 端口。
    *   **主要职责**:
        *   监听来自 ESP32-S3 主控的 TCP 连接。
        *   将从网络收到的所有数据原封不动地转发给 STM32 的串口。
        *   将从 STM32 串口收到的所有数据原封不动地转发回给 ESP32-S3。

---

## 核心功能

*   **精确的站点导航**: 小车通过计算循迹过程中遇到的黑色横线（十字路口）数量来确定自己所在的站点位置。
*   **指令驱动的状态机**:
    1.  小车在起点（0号站）待命。
    2.  收到来自 ESP32-S3 的指令，如 `ARRIVED_PORT_1`，小车进入“取货”模式，目标站点为 1 号。
    3.  到达 1 号站后，小车停止并向主控发送 `ARRIVED_PORT_1` 消息，等待卸货舵机将包裹推到车上。
    4.  检测到包裹后，小车进入“送货”模式，目标站点为 4 号（1->4, 2->5, 3->6）。
    5.  到达 4 号站后，小车驱动自身的舵机将包裹卸下。
    6.  卸货完成后，向主控发送 `ARRIVED_PORT_1-OK` 消息，表示任务完成。
    7.  小车进入“返航”模式，自动返回起点（0号站）等待新指令。

---

## 通信协议 (TCP on Port 8888)

*   **ESP32-S3 (主控) -> 小车 (STM32)**
    *   **指令格式**: `ARRIVED_PORT_X` (其中 `X` 是 `1`, `2`, 或 `3`)
    *   **含义**: 告知小车去指定的取货口（站点）接收包裹。

*   **小车 (STM32) -> ESP32-S3 (主控)**
    *   **到达通知**: `ARRIVED_PORT_X`
        *   **含义**: 小车已到达指定的取货口，准备接收包裹。
    *   **任务完成通知**: `ARRIVED_PORT_X-OK`
        *   **含义**: 小车已将来自 `X` 口的包裹成功送达目的地，并完成卸货。

---

## 如何编译与烧录

本项目包含两部分固件，需要分别烧录。

### 1. STM32U5 主控固件

*   **开发环境**: Keil MDK-ARM (v5) + STM32CubeMX
*   **项目文件**: 本目录下的 `.mxproject` 是 CubeMX 配置文件，`MDK-ARM/` 文件夹内是 Keil 工程。
*   **步骤**:
    1.  使用 Keil MDK 打开 `MDK-ARM/6.car(now).uvprojx` 文件。
    2.  编译工程。
    3.  通过 ST-Link 或其他调试器将固件烧录到 STM32U5 开发板。

### 2. ESP8266 通信固件

*   **开发环境**: Arduino IDE
*   **步骤**:
    1.  在 Arduino IDE 中配置好 ESP8266 开发板环境。
    2.  打开 `ESP8266_Car_Firmware.ino` 文件（您提供的代码）。
    3.  **修改 WiFi 信息**:
        ```cpp
        const char* ssid = "YOUR_WIFI_SSID";
        const char* password = "YOUR_WIFI_PASSWORD";
        ```
    4.  将固件烧录到 ESP8266 开发板。